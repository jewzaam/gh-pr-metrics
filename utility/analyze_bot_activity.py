#!/usr/bin/env python3
# Generated By: Cursor (Claude Sonnet 4.5)
"""
Analyze CSV files for AI bot activity and show top N repos by bot comment count.

This script reads CSV files from a specified directory, extracts AI bot comment
counts, and displays the repositories with the most AI bot activity.
"""

import argparse
import csv
import sys
from pathlib import Path
from typing import Dict, List, Tuple


def analyze_csv_file(csv_path: Path) -> int:
    """
    Analyze a single CSV file and return total AI bot comment count.

    Args:
        csv_path: Path to CSV file

    Returns:
        Total count of AI bot comments in the file
    """
    total = 0
    try:
        with open(csv_path, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                value = row.get("ai_bot_comment_count", "").strip()
                if value.isdigit():
                    total += int(value)
    except Exception as e:
        print(f"Error processing {csv_path}: {e}", file=sys.stderr)
        return 0

    return total


def analyze_directory(directory: Path) -> Dict[str, int]:
    """
    Analyze all CSV files in a directory for AI bot activity.

    Args:
        directory: Path to directory containing CSV files

    Returns:
        Dictionary mapping repository names to AI bot comment counts
    """
    if not directory.exists():
        raise FileNotFoundError(f"Directory not found: {directory}")

    if not directory.is_dir():
        raise NotADirectoryError(f"Not a directory: {directory}")

    results = {}

    # Process all CSV files in directory
    for csv_path in directory.glob("*.csv"):
        if not csv_path.is_file():
            continue

        repo_name = csv_path.stem
        total_comments = analyze_csv_file(csv_path)

        if total_comments > 0:
            results[repo_name] = total_comments

    return results


def format_results(results: Dict[str, int], top_n: int = 10) -> List[Tuple[str, int]]:
    """
    Sort and limit results to top N repositories.

    Args:
        results: Dictionary of repository names to comment counts
        top_n: Number of top results to return

    Returns:
        List of (repo_name, count) tuples sorted by count descending
    """
    sorted_results = sorted(results.items(), key=lambda x: x[1], reverse=True)
    return sorted_results[:top_n]


def print_results(results: List[Tuple[str, int]], top_n: int) -> None:
    """
    Print formatted results table.

    Args:
        results: List of (repo_name, count) tuples
        top_n: Number requested (for header display)
    """
    if not results:
        print("No AI bot activity found in CSV files.")
        return

    print(f"\nTop {min(top_n, len(results))} repos by AI bot comment count:")
    print("=" * 60)
    print()
    print(f"{'Count':<10} {'Repository'}")
    print(f"{'-'*10} {'-'*40}")

    for repo_name, count in results:
        print(f"{count:<10} {repo_name}")


def parse_arguments() -> argparse.Namespace:
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(
        description="Analyze CSV files for AI bot activity",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Analyze current directory, show top 10
  %(prog)s

  # Analyze specific directory
  %(prog)s data/

  # Show top 20 repos
  %(prog)s data/ --top 20
        """,
    )

    parser.add_argument(
        "directory",
        nargs="?",
        default=".",
        help="Directory containing CSV files (default: current directory)",
    )

    parser.add_argument(
        "--top",
        type=int,
        default=10,
        metavar="N",
        help="Number of top repositories to show (default: 10)",
    )

    return parser.parse_args()


def main() -> int:
    """Main entry point."""
    args = parse_arguments()

    directory = Path(args.directory)

    print(f"Analyzing CSV files in: {directory.resolve()}")

    try:
        results = analyze_directory(directory)
        top_results = format_results(results, args.top)
        print_results(top_results, args.top)
        return 0

    except (FileNotFoundError, NotADirectoryError) as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1

    except Exception as e:
        print(f"Unexpected error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
