# Generated By: Cursor (Claude Sonnet 4.5)
"""Tests for REST API pagination."""

import gh_pr_metrics
from github_api import GitHubClient


class TestPagination:
    """Test REST API pagination handling."""

    def test_fetch_issue_comments_with_pagination(self, requests_mock):
        """Test that issue comments are paginated correctly."""
        # Mock first page with Link header
        requests_mock.get(
            "https://api.github.com/repos/test/test/issues/1/comments?per_page=100",
            json=[{"id": i, "user": {"login": f"user{i}", "type": "User"}} for i in range(100)],
            headers={
                "Link": (
                    '<https://api.github.com/repos/test/test/issues/1/comments?page=2>; rel="next"'
                ),
                "X-RateLimit-Remaining": "4999",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        # Mock second page (no more pages)
        requests_mock.get(
            "https://api.github.com/repos/test/test/issues/1/comments?page=2",
            json=[
                {"id": i, "user": {"login": f"user{i}", "type": "User"}} for i in range(100, 115)
            ],
            headers={
                "X-RateLimit-Remaining": "4998",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        client = GitHubClient("fake_token", gh_pr_metrics.quota_manager, gh_pr_metrics.logger)
        comments = client.fetch_issue_comments(
            "https://api.github.com/repos/test/test/issues/1/comments"
        )

        # Should have fetched all 115 comments across 2 pages
        assert len(comments) == 115
        assert comments[0]["id"] == 0
        assert comments[114]["id"] == 114

    def test_fetch_review_comments_with_pagination(self, requests_mock):
        """Test that review comments are paginated correctly."""
        # Mock first page
        requests_mock.get(
            "https://api.github.com/repos/test/test/pulls/1/comments?per_page=100",
            json=[{"id": i, "user": {"login": f"reviewer{i}", "type": "User"}} for i in range(100)],
            headers={
                "Link": (
                    '<https://api.github.com/repos/test/test/pulls/1/comments?page=2>; rel="next"'
                ),
                "X-RateLimit-Remaining": "4999",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        # Mock second page
        requests_mock.get(
            "https://api.github.com/repos/test/test/pulls/1/comments?page=2",
            json=[
                {"id": i, "user": {"login": f"reviewer{i}", "type": "User"}}
                for i in range(100, 150)
            ],
            headers={
                "X-RateLimit-Remaining": "4998",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        client = GitHubClient("fake_token", gh_pr_metrics.quota_manager, gh_pr_metrics.logger)
        comments = client.fetch_review_comments(
            "https://api.github.com/repos/test/test/pulls/1/comments"
        )

        assert len(comments) == 150
        assert comments[0]["id"] == 0
        assert comments[149]["id"] == 149

    def test_fetch_reviews_with_pagination(self, requests_mock):
        """Test that reviews are paginated correctly."""
        # Mock first page
        requests_mock.get(
            "https://api.github.com/repos/test/test/pulls/1/reviews?per_page=100",
            json=[
                {"id": i, "user": {"login": f"reviewer{i}"}, "state": "APPROVED"}
                for i in range(100)
            ],
            headers={
                "Link": (
                    '<https://api.github.com/repos/test/test/pulls/1/reviews?page=2>; rel="next"'
                ),
                "X-RateLimit-Remaining": "4999",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        # Mock second page
        requests_mock.get(
            "https://api.github.com/repos/test/test/pulls/1/reviews?page=2",
            json=[
                {"id": i, "user": {"login": f"reviewer{i}"}, "state": "CHANGES_REQUESTED"}
                for i in range(100, 125)
            ],
            headers={
                "X-RateLimit-Remaining": "4998",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        client = GitHubClient("fake_token", gh_pr_metrics.quota_manager, gh_pr_metrics.logger)
        reviews = client.fetch_reviews("test", "test", 1)

        assert len(reviews) == 125
        assert reviews[0]["state"] == "APPROVED"
        assert reviews[124]["state"] == "CHANGES_REQUESTED"

    def test_fetch_timeline_events_with_pagination(self, requests_mock):
        """Test that timeline events are paginated correctly."""
        # Mock first page
        requests_mock.get(
            "https://api.github.com/repos/test/test/issues/1/events?per_page=100",
            json=[{"id": i, "event": "labeled"} for i in range(100)],
            headers={
                "Link": (
                    '<https://api.github.com/repos/test/test/issues/1/events?page=2>; rel="next"'
                ),
                "X-RateLimit-Remaining": "4999",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        # Mock second page
        requests_mock.get(
            "https://api.github.com/repos/test/test/issues/1/events?page=2",
            json=[{"id": i, "event": "ready_for_review"} for i in range(100, 110)],
            headers={
                "X-RateLimit-Remaining": "4998",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        client = GitHubClient("fake_token", gh_pr_metrics.quota_manager, gh_pr_metrics.logger)
        events = client.fetch_timeline_events("test", "test", 1)

        assert len(events) == 110
        assert events[0]["event"] == "labeled"
        assert events[109]["event"] == "ready_for_review"

    def test_fetch_comments_no_pagination(self, requests_mock):
        """Test fetching comments when only one page exists."""
        requests_mock.get(
            "https://api.github.com/repos/test/test/issues/1/comments?per_page=100",
            json=[{"id": i, "user": {"login": f"user{i}", "type": "User"}} for i in range(10)],
            headers={
                "X-RateLimit-Remaining": "4999",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        client = GitHubClient("fake_token", gh_pr_metrics.quota_manager, gh_pr_metrics.logger)
        comments = client.fetch_issue_comments(
            "https://api.github.com/repos/test/test/issues/1/comments"
        )

        # Should fetch all 10 comments in one page
        assert len(comments) == 10
        assert comments[0]["id"] == 0
        assert comments[9]["id"] == 9
