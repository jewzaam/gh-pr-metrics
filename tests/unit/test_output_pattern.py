# Generated By: Cursor (Claude Sonnet 4.5)
"""Tests for output pattern expansion."""

import sys
from unittest import mock

import gh_pr_metrics


class TestOutputPattern:
    """Test output pattern expansion in various modes."""

    def test_regular_mode_expands_output_pattern(self, tmp_path, requests_mock):
        """Test that regular mode expands {owner} and {repo} in output path."""
        state_file = tmp_path / "state.yaml"
        output_dir = tmp_path / "data"

        # Mock rate limit
        requests_mock.get(
            "https://api.github.com/rate_limit",
            json={"resources": {"core": {"limit": 5000, "remaining": 4999, "reset": 1699999999}}},
        )

        # Mock empty PR list
        requests_mock.get(
            "https://api.github.com/repos/testowner/testrepo/pulls",
            json=[],
        )

        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--owner",
                "testowner",
                "--repo",
                "testrepo",
                "--output",
                f"{output_dir}/{{owner}}_{{repo}}.csv",
                "--start",
                "2024-01-01",
            ],
        ):
            with mock.patch.object(gh_pr_metrics.state_manager, "_state_file", state_file):
                gh_pr_metrics.github_client = gh_pr_metrics.GitHubClient(
                    "fake", gh_pr_metrics.quota_manager, gh_pr_metrics.logger
                )
                result = gh_pr_metrics.main()
                assert result == 0

                # Verify directory was created
                assert output_dir.exists()

                # Verify expanded output path was used (check state file)
                state = gh_pr_metrics.state_manager.load()
                repo_key = "https://github.com/testowner/testrepo"
                assert repo_key in state
                # Should have expanded to testowner_testrepo.csv, not literal {owner}_{repo}.csv
                assert state[repo_key]["csv_file"] == f"{output_dir}/testowner_testrepo.csv"

    def test_init_mode_expands_output_pattern(self, tmp_path, requests_mock):
        """Test that init mode expands output patterns (existing behavior)."""
        state_file = tmp_path / "state.yaml"
        output_dir = tmp_path / "data"

        # Mock rate limit
        requests_mock.get(
            "https://api.github.com/rate_limit",
            json={"resources": {"core": {"limit": 5000, "remaining": 4999, "reset": 1699999999}}},
        )

        # Mock repo validation
        requests_mock.get(
            "https://api.github.com/repos/testowner/testrepo",
            json={"name": "testrepo", "owner": {"login": "testowner"}},
        )

        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--init",
                "--owner",
                "testowner",
                "--repo",
                "testrepo",
                "--output",
                f"{output_dir}/{{owner}}-{{repo}}.csv",
                "--start",
                "2024-01-01",
            ],
        ):
            with mock.patch.object(gh_pr_metrics.state_manager, "_state_file", state_file):
                result = gh_pr_metrics.main()
                assert result == 0

                # Verify state has expanded pattern
                state = gh_pr_metrics.state_manager.load()
                repo_key = "https://github.com/testowner/testrepo"
                assert repo_key in state
                assert state[repo_key]["csv_file"] == f"{output_dir}/testowner-testrepo.csv"

    def test_expand_output_pattern_function(self):
        """Test the expand_output_pattern utility function."""
        assert (
            gh_pr_metrics.expand_output_pattern("data/{owner}-{repo}.csv", "ansible", "handbook")
            == "data/ansible-handbook.csv"
        )

        assert (
            gh_pr_metrics.expand_output_pattern("data/{owner}_{repo}.csv", "test", "repo")
            == "data/test_repo.csv"
        )

        assert (
            gh_pr_metrics.expand_output_pattern("{owner}/{repo}/metrics.csv", "org", "project")
            == "org/project/metrics.csv"
        )

        # No placeholders
        assert (
            gh_pr_metrics.expand_output_pattern("data/output.csv", "test", "repo")
            == "data/output.csv"
        )
