# Generated By: Cursor (Claude Sonnet 4.5)
"""Tests for JSON output functionality."""

import json
from unittest import mock

import gh_pr_metrics
from github_api import GitHubAPIError


class TestBuildPrJsonData:
    """Test building PR JSON data."""

    def test_builds_complete_pr_data(self):
        """Test builds complete PR data with all fields."""
        pr = {
            "number": 123,
            "title": "Test PR",
            "user": {"login": "testuser", "type": "User"},
            "state": "open",
            "created_at": "2024-01-01T00:00:00Z",
            "updated_at": "2024-01-02T00:00:00Z",
            "merged_at": None,
            "closed_at": None,
            "draft": False,
            "html_url": "https://github.com/owner/repo/pull/123",
            "additions": 10,
            "deletions": 5,
            "changed_files": 2,
            "comments_url": "https://api.github.com/repos/owner/repo/issues/123/comments",
            "review_comments_url": "https://api.github.com/repos/owner/repo/pulls/123/comments",
        }

        mock_client = mock.Mock()
        mock_client.fetch_issue_comments.return_value = [
            {
                "id": 1,
                "user": {"login": "commenter", "type": "User"},
                "body": "Comment",
                "created_at": "2024-01-01T10:00:00Z",
                "updated_at": "2024-01-01T10:00:00Z",
            }
        ]
        mock_client.fetch_review_comments.return_value = [
            {
                "id": 2,
                "user": {"login": "reviewer", "type": "User"},
                "body": "Review comment",
                "path": "file.py",
                "line": 10,
                "created_at": "2024-01-01T11:00:00Z",
                "updated_at": "2024-01-01T11:00:00Z",
            }
        ]
        mock_client.fetch_reviews.return_value = [
            {
                "id": 3,
                "user": {"login": "reviewer", "type": "User"},
                "state": "APPROVED",
                "body": "LGTM",
                "submitted_at": "2024-01-01T12:00:00Z",
            }
        ]

        with mock.patch.object(gh_pr_metrics, "github_client", mock_client):
            result = gh_pr_metrics.build_pr_json_data(pr, "owner", "repo")

        assert result["pr_number"] == 123
        assert result["title"] == "Test PR"
        assert result["author"] == "testuser"
        assert result["author_type"] == "User"
        assert len(result["issue_comments"]) == 1
        assert len(result["review_comments"]) == 1
        assert len(result["reviews"]) == 1

    def test_handles_missing_comments_gracefully(self):
        """Test handles API errors when fetching comments."""
        pr = {
            "number": 123,
            "title": "Test PR",
            "user": {"login": "testuser", "type": "User"},
            "state": "open",
            "created_at": "2024-01-01T00:00:00Z",
            "updated_at": "2024-01-02T00:00:00Z",
            "html_url": "https://github.com/owner/repo/pull/123",
            "comments_url": "https://api.github.com/repos/owner/repo/issues/123/comments",
            "review_comments_url": "https://api.github.com/repos/owner/repo/pulls/123/comments",
        }

        mock_client = mock.Mock()
        mock_client.fetch_issue_comments.side_effect = GitHubAPIError("API Error", 500)
        mock_client.fetch_review_comments.side_effect = GitHubAPIError("API Error", 500)
        mock_client.fetch_reviews.side_effect = GitHubAPIError("API Error", 500)

        with mock.patch.object(gh_pr_metrics, "github_client", mock_client):
            result = gh_pr_metrics.build_pr_json_data(pr, "owner", "repo")

        assert result["pr_number"] == 123
        assert len(result["issue_comments"]) == 0
        assert len(result["review_comments"]) == 0
        assert len(result["reviews"]) == 0


class TestWritePrJson:
    """Test writing PR JSON files."""

    def test_creates_provider_aware_directory(self, tmp_path):
        """Test creates github.com/owner/repo directory structure."""
        pr_data = {"pr_number": 123, "title": "Test PR"}

        gh_pr_metrics.write_pr_json(str(tmp_path), "owner", "repo", pr_data)

        expected_dir = tmp_path / "github.com" / "owner" / "repo"
        assert expected_dir.exists()
        assert expected_dir.is_dir()

    def test_writes_json_file_with_correct_name(self, tmp_path):
        """Test writes JSON file with PR number as filename."""
        pr_data = {"pr_number": 456, "title": "Another PR", "author": "user"}

        gh_pr_metrics.write_pr_json(str(tmp_path), "owner", "repo", pr_data)

        json_file = tmp_path / "github.com" / "owner" / "repo" / "456.json"
        assert json_file.exists()

        with open(json_file, "r", encoding="utf-8") as f:
            loaded = json.load(f)
        assert loaded == pr_data

    def test_overwrites_existing_json(self, tmp_path):
        """Test overwrites existing JSON file."""
        repo_dir = tmp_path / "github.com" / "owner" / "repo"
        repo_dir.mkdir(parents=True)

        # Write initial file
        json_file = repo_dir / "789.json"
        json_file.write_text('{"old": "data"}', encoding="utf-8")

        # Write new data
        pr_data = {"pr_number": 789, "title": "Updated PR"}
        gh_pr_metrics.write_pr_json(str(tmp_path), "owner", "repo", pr_data)

        # Verify overwritten
        with open(json_file, "r", encoding="utf-8") as f:
            loaded = json.load(f)
        assert loaded == pr_data

    def test_handles_write_errors_gracefully(self, tmp_path):
        """Test handles write errors without crashing."""
        # Create a directory where the file should be to force error
        repo_dir = tmp_path / "github.com" / "owner" / "repo"
        repo_dir.mkdir(parents=True)
        (repo_dir / "999.json").mkdir()  # Directory instead of file

        pr_data = {"pr_number": 999, "title": "Test PR"}

        # Should not raise exception, just log warning
        gh_pr_metrics.write_pr_json(str(tmp_path), "owner", "repo", pr_data)
        # Test passes if no exception raised
