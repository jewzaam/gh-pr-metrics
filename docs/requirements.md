# GitHub Pull Request Metrics Tool Requirements

Generated By: Cursor (Claude Opus 4)

## Overview

This document defines the functional and non-functional requirements for a GitHub Pull Request metrics tool that generates CSV reports containing key metrics for all pull requests in a specified repository.

## Implementation Specifications

### Tool Identity
- **Tool Name**: `gh-pr-metrics`
- **Version Strategy**: Semantic versioning starting at 0.1.0
- **Package Structure**: Single Python file

### Implementation Details
- **Default Time Range**: Today minus 365 days at current time
- **CSV Format**: RFC 4180 with UTF-8 encoding, Excel-compatible
- **Error Handling for Partial Data**: Include PR with partial data, add `errors` column to CSV if issues occurred
- **Debug Logging**: Include `--debug` flag for troubleshooting
- **Progress Indicators**: Simple counter (e.g., "Processing PR 45/150...")

### Testing Requirements
- **Framework**: pytest
- **Type Hints**: Basic type hints for code documentation (full mypy validation optional)

## Functional Requirements

### FR1: Command Line Interface

#### FR1.1: Repository Configuration
- **FR1.1.1**: Accept repository URL parameter (default: github.com)
- **FR1.1.2**: Accept repository owner parameter (default: current repository's owner from git config)
- **FR1.1.3**: Accept repository name parameter (default: current repository's name from git config)
- **FR1.1.4**: Support both SSH and HTTPS git remote URL formats for auto-detection

#### FR1.2: Time Range Configuration
- **FR1.2.1**: Accept start timestamp parameter (default: today minus 365 days)
- **FR1.2.2**: Accept end timestamp parameter (default: current date/time)
- **FR1.2.3**: Support common date formats (ISO 8601, RFC 3339, Unix timestamp)
- **FR1.2.4**: Validate that start timestamp is before end timestamp

#### FR1.3: Output Configuration
- **FR1.3.1**: Generate output as CSV format
- **FR1.3.2**: Write CSV to stdout by default
- **FR1.3.3**: Accept optional output file path parameter

#### FR1.5: Bot Classification
- **FR1.5.1**: Accept `--ai-bot-regex` parameter to identify AI bots
- **FR1.5.2**: Default regex pattern: `cursor\[bot\]`
- **FR1.5.3**: Support standard regex syntax for pattern matching
- **FR1.5.4**: Support empty/None pattern to disable AI bot detection (all bots treated as non-AI)

#### FR1.4: Debug and Logging
- **FR1.4.1**: Accept `--debug` flag to enable detailed logging for troubleshooting
- **FR1.4.2**: Display progress indicators showing current processing status

### FR2: Data Collection

#### FR2.1: Pull Request Processing
- **FR2.1.1**: Process all pull requests from the specified repository
- **FR2.1.2**: Include pull requests created within the specified time range
- **FR2.1.3**: Include pull requests in all states (open, closed, merged, draft)

#### FR2.2: Pull Request Metrics
- **FR2.2.1**: Collect PR creation timestamp
- **FR2.2.2**: Determine when PR was last marked ready for review
  - For PRs never in draft: use creation timestamp
  - For PRs converted from draft: find the latest "ready_for_review" event timestamp
- **FR2.2.3**: Count all comments including:
  - Issue comments (comments on the PR itself)
  - Review comments (inline code comments)
  - All comment types regardless of author type
- **FR2.2.4**: Count non-AI bot comments separately
  - Identify bot comments based on user type (type == "Bot")
  - Exclude AI bots from this count
  - Provide separate metric for non-AI bot comment count
  - Track non-AI bot login names (comma-separated list)
- **FR2.2.5**: Count AI bot comments separately
  - Identify AI bot comments using regex pattern
  - Default pattern: `cursor\[bot\]`
  - Pattern configurable via `--ai-bot-regex` CLI argument
  - Provide separate metric for AI bot comment count
  - Track AI bot login names (comma-separated list)
- **FR2.2.6**: Count total number of change requests
  - Count all reviews with "CHANGES_REQUESTED" state
  - Include all requests regardless of reviewer uniqueness
- **FR2.2.7**: Count unique reviewers who requested changes
  - Count distinct reviewers who have submitted change requests
- **FR2.2.7**: Count number of approvals
  - Count reviews with "APPROVED" state
  - Use the most recent review state per reviewer
- **FR2.2.8**: Capture current PR status:
  - "draft" - PR is currently in draft state
  - "open" - PR is open and ready for review
  - "closed" - PR is closed without merging
  - "merged" - PR has been merged

### FR3: CSV Output Format

#### FR3.1: CSV Structure
- **FR3.1.1**: Include header row with column names
- **FR3.1.2**: Use standard CSV format (RFC 4180 compliant)
- **FR3.1.3**: Handle special characters and escaping properly
- **FR3.1.4**: Use UTF-8 encoding

#### FR3.2: Required Columns
- **FR3.2.1**: `pr_number` - Pull request number
- **FR3.2.2**: `title` - Pull request title
- **FR3.2.3**: `author` - Pull request author username
- **FR3.2.4**: `created_at` - ISO 8601 timestamp when PR was created
- **FR3.2.5**: `ready_for_review_at` - ISO 8601 timestamp when PR was last marked ready
- **FR3.2.6**: `total_comment_count` - Total number of all comments (includes all bot and human comments)
- **FR3.2.7**: `non_ai_bot_comment_count` - Number of comments from non-AI bots (excludes AI bots)
- **FR3.2.8**: `ai_bot_comment_count` - Number of comments from AI bots only
- **FR3.2.9**: `non_ai_bot_login_names` - Comma-separated list of non-AI bot logins that commented
- **FR3.2.10**: `ai_bot_login_names` - Comma-separated list of AI bot logins that commented
- **FR3.2.11**: `changes_requested_count` - Total number of change requests
- **FR3.2.12**: `unique_change_requesters` - Count of unique reviewers who requested changes
- **FR3.2.13**: `approval_count` - Number of approvals
- **FR3.2.14**: `status` - Current PR status
- **FR3.2.15**: `url` - Full URL to the pull request
- **FR3.2.16**: `errors` - Optional column with error messages if partial data was retrieved

### FR4: Authentication

#### FR4.1: GitHub Authentication
- **FR4.1.1**: Support unauthenticated requests for public repositories
- **FR4.1.2**: Support GitHub personal access token via environment variable (`GITHUB_TOKEN`)
- **FR4.1.3**: Make direct GitHub REST API calls using requests library
- **FR4.1.4**: Display clear error messages for authentication failures

### FR5: Error Handling

#### FR5.1: Input Validation
- **FR5.1.1**: Validate repository owner and name format
- **FR5.1.2**: Validate timestamp formats and ranges
- **FR5.1.3**: Provide clear error messages for invalid inputs

#### FR5.2: API Error Handling
- **FR5.2.1**: Handle rate limit errors gracefully with informative messages
- **FR5.2.2**: Handle network timeouts and connection errors
- **FR5.2.3**: Handle repository not found errors
- **FR5.2.4**: Handle insufficient permissions errors

## Non-Functional Requirements

### NFR1: Performance

#### NFR1.1: Efficiency
- **NFR1.1.1**: Process pull requests using GitHub API pagination (100 PRs per page)

#### NFR1.2: Scalability
- **NFR1.2.1**: Handle repositories with large numbers of pull requests
- **NFR1.2.2**: Use streaming/iterative processing to manage memory usage

### NFR2: Usability

#### NFR2.1: User Experience
- **NFR2.1.1**: Provide progress indicators for long-running operations
- **NFR2.1.2**: Display helpful usage information with --help flag
- **NFR2.1.3**: Use clear and consistent command-line argument naming
- **NFR2.1.4**: Provide meaningful default values to minimize required arguments

#### NFR2.2: Documentation
- **NFR2.2.1**: Include comprehensive --help documentation
- **NFR2.2.2**: Provide examples of common usage patterns
- **NFR2.2.3**: Document all environment variables

### NFR3: Reliability

#### NFR3.1: Robustness
- **NFR3.1.1**: Continue processing remaining PRs if individual PR fails
- **NFR3.1.2**: Log errors without terminating the entire process
- **NFR3.1.3**: Collect errors in the errors column of CSV output for partial data

#### NFR3.2: Data Integrity
- **NFR3.2.1**: Ensure CSV output is valid even with special characters in PR data
- **NFR3.2.2**: Handle missing or null values appropriately
- **NFR3.2.3**: Preserve data precision for timestamps

### NFR4: Maintainability

#### NFR4.1: Code Quality
- **NFR4.1.1**: Follow Python coding standards (PEP 8)
- **NFR4.1.2**: Include type hints for better code clarity
- **NFR4.1.3**: Write modular, testable code with clear separation of concerns

#### NFR4.2: Testing
- **NFR4.2.1**: Achieve good code coverage with unit tests (82%+ achieved, minimum 75% enforced)
- **NFR4.2.2**: Provide structure for integration tests (directory created for future use)
- **NFR4.2.3**: Mock external dependencies in unit tests
- **NFR4.2.4**: Isolate test state (state file, quota manager, file logging) via conftest.py fixtures

### NFR5: Compatibility

#### NFR5.1: Platform Support
- **NFR5.1.1**: Support Python 3.8 and newer versions
- **NFR5.1.2**: Work on Linux, macOS, and Windows platforms
- **NFR5.1.3**: Support GitHub.com

#### NFR5.2: API Compatibility
- **NFR5.2.1**: Use stable GitHub API v3 (REST) endpoints
- **NFR5.2.2**: Handle API version changes gracefully
- **NFR5.2.3**: Support GitHub's recommended API practices

## Constraints and Assumptions

### Constraints
- **C1**: Tool must work within GitHub API rate limits
- **C2**: Cannot control GitHub API response times
- **C3**: Limited to data available through GitHub's public API
- **C4**: Cannot modify or update pull request data

### Assumptions
- **A1**: Users have appropriate access to target repositories
- **A2**: GitHub API remains available and stable
- **A3**: Network connectivity is available
- **A4**: System has Python 3.8+ installed
- **A5**: Users understand basic command-line usage

## Future Considerations (Out of Scope)

The following features are not included in the current requirements but may be considered for future versions:

### Planned for Future Versions
- **GitHub CLI Authentication**: Automatic detection and use of `gh` CLI credentials
- **Retry Logic**: Automatic retry with exponential backoff for transient network failures
- **Rate Limit Management**: Intelligent delays and rate limit header monitoring
- **Iterative Processing**: Support for idempotent processing and tracking changes between runs
- **Interruption and Resumption**: Ability to pause and resume long-running operations
- **Multiple Repository Support**: Process multiple repositories in a single run
- **GitLab Support**: Extend support to GitLab repositories (API differences need investigation)
- **Integration Tests**: Real GitHub API testing and end-to-end workflow validation

### Additional Future Enhancements
- GraphQL API support for more efficient data fetching
- Caching mechanisms for repeated queries
- Custom output formats (JSON, HTML reports)
- Filtering by PR labels, authors, or other criteria
- Real-time monitoring or webhook integration
- Statistical analysis or visualization features
- Increased code coverage to 80%+
