# Generated By: Cursor (Claude Sonnet 4.5)
"""Tests for GitHub API interactions."""

from unittest import mock
import pytest
import requests

import gh_pr_metrics


class TestGitHubAPIClient:
    """Test GitHub API client functionality."""

    def test_get_github_token_from_env(self):
        """Test getting GitHub token from environment."""
        with mock.patch.dict("os.environ", {"GITHUB_TOKEN": "test_token"}):
            token = gh_pr_metrics.get_github_token()
            assert token == "test_token"

    def test_get_github_token_none_when_not_set(self):
        """Test getting GitHub token when not set."""
        with mock.patch.dict("os.environ", {}, clear=True):
            token = gh_pr_metrics.get_github_token()
            assert token is None

    def test_make_github_request_success(self, requests_mock):
        """Test successful GitHub API request."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(url, json={"name": "repo"})

        result = gh_pr_metrics.make_github_request(url)
        assert result == {"name": "repo"}

    def test_make_github_request_with_token(self, requests_mock):
        """Test GitHub API request with authentication token."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(url, json={"name": "repo"})

        gh_pr_metrics.make_github_request(url, token="test_token")
        assert "Authorization" in requests_mock.last_request.headers
        assert requests_mock.last_request.headers["Authorization"] == "Bearer test_token"

    def test_make_github_request_rate_limit_error(self, requests_mock):
        """Test handling of rate limit errors."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(
            url,
            status_code=403,
            json={"message": "rate limit"},
            headers={
                "X-RateLimit-Remaining": "0",
                "X-RateLimit-Limit": "5000",
                "X-RateLimit-Reset": "1699999999",
            },
        )

        with pytest.raises(gh_pr_metrics.GitHubAPIError, match="rate limit"):
            gh_pr_metrics.make_github_request(url)

    def test_make_github_request_not_found_error(self, requests_mock):
        """Test handling of 404 errors."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(url, status_code=404)

        with pytest.raises(gh_pr_metrics.GitHubAPIError, match="not found"):
            gh_pr_metrics.make_github_request(url)

    def test_make_github_request_network_error(self, requests_mock):
        """Test handling of network errors."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(url, exc=requests.exceptions.ConnectionError)

        with pytest.raises(gh_pr_metrics.GitHubAPIError, match="Network error"):
            gh_pr_metrics.make_github_request(url)

    def test_make_github_request_401_unauthorized(self, requests_mock):
        """Test handling of 401 unauthorized errors."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(url, status_code=401)

        with pytest.raises(gh_pr_metrics.GitHubAPIError, match="unauthorized"):
            gh_pr_metrics.make_github_request(url)

    def test_make_github_request_403_forbidden_not_rate_limit(self, requests_mock):
        """Test handling of 403 forbidden errors that are not rate limits."""
        url = "https://api.github.com/repos/owner/repo"
        requests_mock.get(
            url,
            status_code=403,
            json={"message": "forbidden"},
            headers={"X-RateLimit-Remaining": "100"},  # Not a rate limit
        )

        with pytest.raises(gh_pr_metrics.GitHubAPIError, match="insufficient permissions"):
            gh_pr_metrics.make_github_request(url)

class TestFetchPRs:
    """Test PR fetching with pagination logic."""

    def test_fetch_prs_page_stops_at_start_date(self, requests_mock):
        """Test that fetch_pull_requests_page stops when PRs are before start date."""
        from datetime import datetime, timezone, timedelta

        now = datetime.now(timezone.utc)
        start_date = now - timedelta(days=7)
        end_date = now

        # Mock PRs - some in range, some before start_date (sorted by updated_at)
        prs_page = [
            {"number": 3, "updated_at": (now - timedelta(days=2)).isoformat()},
            {"number": 2, "updated_at": (now - timedelta(days=5)).isoformat()},
            {"number": 1, "updated_at": (now - timedelta(days=10)).isoformat()},  # Before start
        ]

        url_base = "https://api.github.com/repos/owner/repo/pulls"
        requests_mock.get(
            f"{url_base}?state=all&sort=updated&direction=asc&per_page=100&page=1",
            json=prs_page,
        )

        result, has_more = gh_pr_metrics.fetch_pull_requests_page(
            "owner", "repo", start_date, end_date, None, page=1
        )

        # Should only get the 2 PRs in range
        assert len(result) == 2
        assert result[0]["number"] == 3
        assert result[1]["number"] == 2
        # Should indicate no more pages (stopped at start_date)
        assert has_more is False

    def test_fetch_prs_page_indicates_no_more(self, requests_mock):
        """Test that fetch_pull_requests_page correctly indicates no more pages."""
        from datetime import datetime, timezone, timedelta

        now = datetime.now(timezone.utc)
        start_date = now - timedelta(days=365)
        end_date = now

        # Mock PRs - single page with only 50 results (less than 100)
        prs = [
            {"number": i, "updated_at": (now - timedelta(days=i)).isoformat()} for i in range(1, 51)
        ]

        url_base = "https://api.github.com/repos/owner/repo/pulls"
        requests_mock.get(
            f"{url_base}?state=all&sort=updated&direction=asc&per_page=100&page=1",
            json=prs,
        )

        result, has_more = gh_pr_metrics.fetch_pull_requests_page(
            "owner", "repo", start_date, end_date, None, page=1
        )

        # Should get all 50 PRs
        assert len(result) == 50
        # Should indicate no more pages (< 100 results)
        assert has_more is False

    def test_fetch_prs_multiple_pages_in_range(self, requests_mock):
        """Test that fetch_pull_requests handles multiple pages of results."""
        from datetime import datetime, timezone, timedelta

        now = datetime.now(timezone.utc)
        start_date = now - timedelta(days=365)
        end_date = now

        # Mock multiple pages of PRs all in range
        prs_page1 = [
            {"number": i + 100, "updated_at": (now - timedelta(days=i)).isoformat()}
            for i in range(100)
        ]
        prs_page2 = [
            {"number": i, "updated_at": (now - timedelta(days=i + 100)).isoformat()}
            for i in range(100)
        ]

        url_base = "https://api.github.com/repos/owner/repo/pulls"
        requests_mock.get(
            f"{url_base}?state=all&sort=updated&direction=asc&per_page=100&page=1",
            json=prs_page1,
        )
        requests_mock.get(
            f"{url_base}?state=all&sort=updated&direction=asc&per_page=100&page=2",
            json=prs_page2,
        )
        requests_mock.get(
            f"{url_base}?state=all&sort=updated&direction=desc&per_page=100&page=2",
            json=prs_page2,
        )

        result, has_more = gh_pr_metrics.fetch_pull_requests_page(
            "owner", "repo", start_date, end_date, None, page=1
        )

        # Should get all 100 PRs from page 1
        assert len(result) == 100
        # Should indicate more pages available
        assert has_more is True
