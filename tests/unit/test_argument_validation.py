# Generated By: Cursor (Claude Sonnet 4.5)
"""Tests for command-line argument validation in main()."""

import sys
from unittest import mock

import gh_pr_metrics


class TestArgumentValidation:
    """Test argument combination validation rules."""

    def test_wait_requires_update_all(self):
        """Test that --wait can only be used with --update-all."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--wait", "--owner", "test", "--repo", "test", "--update"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_cannot_use_start(self):
        """Test that --update cannot be used with --start."""
        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--update",
                "--owner",
                "test",
                "--repo",
                "test",
                "--start",
                "2024-01-01",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_cannot_use_end(self):
        """Test that --update cannot be used with --end."""
        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--update",
                "--owner",
                "test",
                "--repo",
                "test",
                "--end",
                "2024-12-31",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_all_cannot_use_output(self):
        """Test that --update-all cannot be used with --output."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update-all", "--output", "test.csv"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_all_cannot_use_start(self):
        """Test that --update-all cannot be used with --start."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update-all", "--start", "2024-01-01"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_all_cannot_use_end(self):
        """Test that --update-all cannot be used with --end."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update-all", "--end", "2024-12-31"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_all_cannot_use_owner(self):
        """Test that --update-all cannot be used with --owner."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update-all", "--owner", "test"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_all_cannot_use_repo(self):
        """Test that --update-all cannot be used with --repo."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update-all", "--repo", "test"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_update_and_update_all_cannot_be_combined(self):
        """Test that --update and --update-all cannot be used together."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--update", "--update-all", "--owner", "test", "--repo", "test"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_start_date_must_be_before_end_date(self, requests_mock):
        """Test that start date must be before end date."""
        # Mock rate limit
        requests_mock.get(
            "https://api.github.com/rate_limit",
            json={"resources": {"core": {"limit": 5000, "remaining": 4999, "reset": 1699999999}}},
        )

        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--owner",
                "test",
                "--repo",
                "test",
                "--start",
                "2024-12-31",
                "--end",
                "2024-01-01",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_pr_requires_output(self):
        """Test that --pr requires --output."""
        with mock.patch.object(
            sys,
            "argv",
            ["gh-pr-metrics", "--owner", "test", "--repo", "test", "--pr", "123"],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_pr_cannot_use_init(self):
        """Test that --pr cannot be used with --init."""
        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--owner",
                "test",
                "--repo",
                "test",
                "--pr",
                "123",
                "--output",
                "test.csv",
                "--init",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_pr_cannot_use_update(self):
        """Test that --pr cannot be used with --update."""
        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--owner",
                "test",
                "--repo",
                "test",
                "--pr",
                "123",
                "--output",
                "test.csv",
                "--update",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1

    def test_pr_cannot_use_update_all(self):
        """Test that --pr cannot be used with --update-all."""
        with mock.patch.object(
            sys,
            "argv",
            [
                "gh-pr-metrics",
                "--pr",
                "123",
                "--output",
                "test.csv",
                "--update-all",
            ],
        ):
            result = gh_pr_metrics.main()
            assert result == 1
