#!/usr/bin/env python3
# Generated By: Cursor (Claude Sonnet 4.5)
"""
Base Command Module

Abstract base class for all commands with common initialization and setup.
"""

import argparse
import logging
from abc import ABC, abstractmethod
from pathlib import Path
from typing import Optional

from managers import (
    Config,
    load_config,
    StateManager,
    QuotaManager,
    CSVManager,
    LoggingManager,
)
from github_api import GitHubClient


class BaseCommand(ABC):
    """
    Abstract base class for all commands.

    Provides common initialization, configuration loading, and manager setup.
    Subclasses implement specific command logic.
    """

    def __init__(self):
        """Initialize base command."""
        self.config: Optional[Config] = None
        self.state_manager: Optional[StateManager] = None
        self.quota_manager: Optional[QuotaManager] = None
        self.csv_manager: Optional[CSVManager] = None
        self.logger: Optional[LoggingManager] = None
        self.github_client: Optional[GitHubClient] = None

    def needs_github_client(self) -> bool:
        """
        Whether this command needs GitHub client initialization.

        Returns:
            True if GitHub client needed (default), False otherwise
        """
        return True

    def setup(self, args: argparse.Namespace) -> None:
        """
        Common setup for all commands.

        Args:
            args: Parsed command-line arguments

        Sets up:
        - Logging
        - Configuration
        - Managers (state, quota, CSV, logging)
        - GitHub client (if needed)
        """
        # Setup logging
        log_level = logging.DEBUG if args.debug else logging.INFO
        logging.basicConfig(
            level=log_level,
            format="%(asctime)s - %(levelname)s - %(message)s",
            datefmt="%Y-%m-%d %H:%M:%S",
        )

        # Load configuration
        config_path = args.config
        self.config = load_config(config_path)

        # Configure file logging if specified
        if hasattr(self.config, "log_file") and self.config.log_file:
            file_handler = logging.FileHandler(self.config.log_file)
            file_handler.setLevel(log_level)
            file_handler.setFormatter(
                logging.Formatter(
                    "%(asctime)s - %(levelname)s - %(message)s", datefmt="%Y-%m-%d %H:%M:%S"
                )
            )
            logging.getLogger().addHandler(file_handler)

        # Initialize managers
        self.quota_manager = QuotaManager()
        self.logger = LoggingManager(self.quota_manager)

        # State manager default path
        state_file_path = Path.home() / ".gh-pr-metrics-state.yaml"
        self.state_manager = StateManager(state_file_path, logger=self.logger)

        self.csv_manager = CSVManager(logger=self.logger)

        # Initialize GitHub client if needed
        if self.needs_github_client():
            token = self._get_github_token()
            self.github_client = GitHubClient(token, self.quota_manager, self.logger)

            # Initialize quota
            self.logger.info("Initializing GitHub API quota...")
            rate_info = self.quota_manager.initialize(token)
            if rate_info:
                self.logger.info(
                    "API quota: %d/%d remaining (resets at %s)",
                    rate_info["remaining"],
                    rate_info["limit"],
                    rate_info.get("reset", "unknown"),
                )

    def _get_github_token(self) -> Optional[str]:
        """Get GitHub token from environment."""
        import os

        return os.environ.get("GITHUB_TOKEN")

    @abstractmethod
    def add_arguments(self, parser: argparse.ArgumentParser) -> None:
        """
        Add command-specific arguments to parser.

        Args:
            parser: Argument parser for this command

        Subclasses must implement this to define their specific arguments.
        """
        pass

    @abstractmethod
    def run(self, args: argparse.Namespace) -> int:
        """
        Execute the command.

        Args:
            args: Parsed command-line arguments

        Returns:
            Exit code (0 for success, non-zero for failure)

        Subclasses must implement this to define their specific logic.
        """
        pass
